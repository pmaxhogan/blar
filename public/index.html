<!DOCTYPE html>
<!--suppress HtmlFormInputWithoutLabel -->
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="Description" content="Shorten URLs with Blar.tk">
    <title>blar.tk - shorten URLs</title>


    <style media="screen">
      :root {
        --border-size: 5px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        min-width: 100vw;
        min-height: 100vh;
      }

      body {
        font-size: 8vw;
        font-family: "monospace";
        margin: 0;
        padding: 0;
        user-select: none;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      section {
        width: 100%;
      }

      .entry-input,
      .action-button{
        flex-grow: 1;
        font-size: inherit;
        font-family: inherit;
        border: none;
      }

      .entry-input:focus,
      .action-button {
        outline: none;
      }

      .big {
        width: 90%;
        max-width: 90%;
        margin: 0 auto;
        display: flex;
      }

      .small-text{
        font-size: 1vw;
      }

      #fixedinput {
        min-height: 7vw;
        display: flex;
        align-items: center;
      }

      #fixedinput,
      input {
        width: 100%;
      }

      .action-button{
        flex-grow: 0;
        cursor: pointer;
      }

      #url:valid {
        border: var(--border-size) solid transparent;
      }

      #url:focus:not(:valid) {
        border: var(--border-size) solid red;
        border-radius: 10px;
      }

      a#result-link {
        color: black;
      }

      .accessibility{
        display: none;
      }
    </style>
  </head>
  <body>
    <main>
      <section id="create-section">
          <div class="big">
            <div id="fixedinput">
              <span id="url-label" class="accessibility">Enter a URL</span>
              <input type="url" class="entry-input" autocomplete="off" spellcheck="false" placeholder="paste a URL" id="url" aria-labelledby="url-label">
            </div>
          </div>
          <div class="big">
            blar.tk/<span id="path-label" class="accessibility">Enter a desired path</span><input class="entry-input" autocomplete="off" spellcheck="false" placeholder="(optional)" name="path" id="path" aria-labelledby="path-label">
          </div>
          <div class="big">
            <button class="action-button" id="submit">go</button>
          </div>
      </section>
      <section id="finished-section" hidden>
        <div class="big"><a id="result-link" href="https://example.com">example.com</a></div>
        <div class="big small-text">click to copy</div>
        <div class="big"><button class="action-button" id="return">again</button></div>
      </section>
    </main>

    <script>
      const createSection = document.querySelector("#create-section");
      const finishedSection = document.querySelector("#finished-section");

      const urlElem = document.querySelector("#url");
      const pathElem = document.querySelector("#path");
      const submitElem = document.querySelector("#submit");

      const resultLink = document.querySelector("#result-link");
      const returnElem = document.querySelector("#return");

      const maxUrlLength = 18;
      const removeSuffixes = [".html", ".php"];
      const isHttps = true;
      const basePath = "blar.tk/";
      const apiPath = "shorten";

      let wasValid = false;

      const shortenUrl = async (path, dest) => {
        const resp = await fetch(`${apiPath}?${path ? "path=" + path + "&": ""}dest=${dest}`, {method: "POST"});
        const data = await resp.json();

        if(data.errors && data.errors.length && (!data.errors.length === 1 || data.errors[0] === "dest already exists")){
          throw new Error("Got errors: " + data.errors.join("\n"));
        }

        return data.path;
      };

      const again = () => {
        urlElem.value = "";
        urlElem.oldValue = undefined;
        pathElem.value = "";

        createSection.hidden = false;
        finishedSection.hidden = true;
      };

      const submit = async () => {
        if(wasValid){
          const finalUrl = basePath + await shortenUrl(path.value, urlElem.oldValue || urlElem.value);

          createSection.hidden = true;
          finishedSection.hidden = false;

          resultLink.href = (isHttps ? "https://" : "http://") + finalUrl;
          resultLink.innerText = finalUrl;
        }
      };

      // urlElem.addEventListener("input", e => {
      // 	const size = (7 - (Math.sqrt(urlElem.value.length)) * 1.8);
      // 	e.target.style.fontSize = Math.max(size, 10) + "vw";
      // });

      urlElem.addEventListener("focus", () => {
        if (urlElem.oldValue) {
          urlElem.value = urlElem.oldValue;
          urlElem.select();
        }
      });

      urlElem.addEventListener("blur", () => {
        wasValid = urlElem.validity.valid;
        if(urlElem.validity.valid){
          if (urlElem.value) {
            urlElem.oldValue = urlElem.value;
            const url = new URL(urlElem.value);
            let newVal;

            let hostname = url.hostname;

            if(hostname.length > 8 && hostname.startsWith("www.")){
              hostname = hostname.replace("www.", "");
            }

            if(url.pathname === "/" || url.hostname.length > maxUrlLength){
              newVal = `${hostname.slice(0, maxUrlLength)}`;
            }else{
              newVal = `${hostname}â€¦`;
              let pathname = url.pathname;

              for(const removeSuffix of removeSuffixes){
                if(pathname.endsWith(removeSuffix)){
                  pathname = pathname.slice(0, pathname.lastIndexOf(removeSuffix));
                }
              }

              if(pathname.charAt(pathname.length - 1) === "/"){
                pathname = url.pathname.slice(0, -1);
              }
              newVal += pathname.slice(-(maxUrlLength - newVal.length));
            }
            urlElem.value = newVal;
          }
        }
      });

      urlElem.addEventListener("paste", e => {
        setTimeout(() => {
          if(urlElem.validity.valid){
            path.focus();
          }
        }, 0);
      });

      pathElem.addEventListener("keypress", e => {
        if(e.key === "Enter") submit();
      });

      submitElem.addEventListener("click", submit);

      returnElem.addEventListener("click", again);

      resultLink.addEventListener("click", e => {
        e.preventDefault();
        navigator.clipboard.writeText(resultLink.href).catch(() => {
          prompt("Copy this text", resultLink.href);
        });
      });
    </script>
  </body>
</html>
